def smrtSrch(query):
    try: 
        c, conn = create_connection(app,'chemitrycmpds')
        smiRepo = c.execute('SELECT Common_Name, SMILES FROM CSdb_addn')
        smiRepo = c.fetchall()
        collection = indigo.createArray()
        mols = {name:indigo.loadMolecule(smiStr) for name,smiStr in smiRepo
        if strings}
        for name,mol in mols:
            tgt = indigo.loadMolecule(mol)
            match = indigo.substructureMatch(tgt).match(query)
            if match:
                try:
                    matching = match.highlightedTarget()
                    matching = foldHydrogens()
                    matching.layout()
                    matching.setProperty("grid-comment",name)
                    collection.arrayAdd(matching)
                    indigo.setOption('render-output-format','svg')
                    indigo.setOption('render-comment-position','bottom')
                    indigo.setOption('render-comment-alignment','center')
                    indigo.setOption('render-comment-offset',2)
                    indigo.setOption('render-grid-title-property','grid-comment')
                    indigo.setOption('render-relative-thickness',1.32)
                    indigo.setOption('render-label-mode','hetero')
                    indigo.setOption('render-stereo-style','none')
                    indigo.setOption('render-margins',1,1)
                except (IndigoException,AttributeError):
                    pass
        return collection
    except Exception as e:
        return str(e)

def dplyStruc(csid):
    try: 
        c, conn = create_connection(app,'chemitrycmpds')
        smiRepo = c.execute('SELECT Common_Name, SMILES FROM CSdb_addn WHERE ChemSpider_ID = (%s)', csid)
        smiRepo = c.fetchall()[0]
        try:
            name = smiRepo[0]
            mol = indigo.loadMolecule(smiRepo[1]) 
            mol.layout()
            mol.foldHydrogens()
            indigo.setOption('render-output-format','svg')
            indigo.setOption('render-comment',name)
            indigo.setOption('render-comment-position','top') 
            indigo.setOption('render-comment-alignment','center')
            indigo.setOption('render-comment-font-size','5') 
            indigo.setOption('render-comment-offset',2) 
            indigo.setOption('render-relative-thickness',1.35)
            indigo.setOption('render-label-mode','hetero')
            indigo.setOption('render-stereo-style','none') 
            indigo.setOption('render-coloring',True) 
            #indigo.setOption('render-image-size',300,350) 
            svg = renderer.renderToBuffer(mol)
            svg = svg.tostring().decode('utf-8')
            return svg
        except (IndigoException,AttributeError):
            return 'There was an issue rendering the image with the Indigo engine'
    except Exception:
        return 'That ChemSpider ID does not exist in the database!'
